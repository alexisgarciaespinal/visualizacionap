{% extends "base.html" %}

{% block title %}
    Ficha Técnica
{% endblock %}

{% block content %}
<style>
    body {
        font-family: Arial, sans-serif;
        background-color: #f8f9fa;
        color: #343a40;
        margin: 0; /* Eliminar márgenes para que ocupe toda la página */
        padding: 20px; /* Espaciado interno */
        box-sizing: border-box; /* Para que el padding no afecte el tamaño */
    }

    .table {
        width: 100%;
        margin-bottom: 1rem;
        background-color: #fff;
        border-radius: 0.25rem;
        overflow: hidden;
        table-layout: auto; /* Permitir ajuste automático de columnas */
    }

    .table th, .table td {
        padding: 12px;
        vertical-align: middle;
        border-top: 1px solid #dee2e6;
        word-wrap: break-word; /* Permitir que el texto largo se ajuste */
    }

    .table thead th {
        background-color: #007bff;
        color: white;
    }

    .table tbody tr:nth-child(even) {
        background-color: #f2f2f2;
    }

    .dt-button {
        background-color: #007bff;
        color: white;
        border: none;
        border-radius: 0.25rem;
        padding: 8px 12px;
        margin-right: 5px;
        cursor: pointer;
    }

    .dt-button:hover {
        background-color: #0056b3;
    }

    h2 {
        margin-top: 30px;
        color: #007bff;
    }

    .graph-container {
        margin: 20px 0;
        border: 1px solid #dee2e6;
        padding: 15px;
        background-color: #fff;
        border-radius: 0.25rem;
    }

    .form-group {
        margin-bottom: 20px;
    }

    .map-container {
        width: 100%;
        height: 600px;
        margin: 0 auto;
    }

    .folium-map {
        width: 100%; /* Ancho completo */
        height: 600px; /* Altura ajustada para un tamaño específico */
        border: 1px solid #ccc; /* Borde opcional */
    }
</style>

<h2>Datos Ficha Técnica 24-25</h2>

<div style="overflow-x: auto;">
    <table id="miTabla" class="table table-bordered table-striped">
        <thead>
            <tr>
                <th>Fecha/Hora</th>
                <th>Lote</th>
                <th>Turno</th>
                <th>Válvula</th>
                <th>Área</th>
                <th>Ciclo</th>
                <th>Variedad</th>
                <th>Edad</th>
                <th>Muestra</th>
                <th>Tamaño Muestra</th>
                <th>Hojas por Día</th>
                <th>Guías</th>
                <th>Entrenudos</th>
                <th>CE Goteros</th>
                <th>pH Goteros</th>
                <th>CE Extractores</th>
                <th>pH Extractores</th>
                <th>CE Suelo</th>
                <th>pH Suelo</th>
                <th>Tensiometro 12 (cm)</th>
                <th>Tensiometro 24 (cm)</th>
                <th>Observaciones</th>
                <th>Latitud</th>
                <th>Longitud</th>
            </tr>
        </thead>
        <tbody>
            {% for item in data %}
            <tr>
                <td>{{ item['Fecha/Hora'] or 'null' }}</td>
                <td>{{ item['Lote'] or ' ' }}</td>
                <td>{{ item['Turno'] or ' ' }}</td>
                <td>{{ item['Valvula'] or ' ' }}</td>
                <td>{{ item['Area'] or ' ' }}</td>
                <td>{{ item['Ciclo'] or ' ' }}</td>
                <td>{{ item['Variedad'] or ' ' }}</td>
                <td>{{ item['Edad_cultivo'] or ' ' }}</td>
                <td>{{ item['Muestra'] or ' ' }}</td>
                <td>{{ item['Tamaño_Muestra'] or ' ' }}</td>
                <td>{{ item['Hojas_dia'] or ' ' }}</td>
                <td>{{ item['Guias'] or ' ' }}</td>
                <td>{{ item['Entrenudos'] or ' ' }}</td>
                <td>{{ item['CE_gotero'] or ' ' }}</td>
                <td>{{ item['PH_gotero'] or ' ' }}</td>
                <td>{{ item['CE_extractor'] or ' ' }}</td>
                <td>{{ item['PH_extractor'] or ' ' }}</td>
                <td>{{ item['CE_suelo'] or ' ' }}</td>
                <td>{{ item['PH_suelo'] or ' ' }}</td>
                <td>{{ item['Tensiometro_12'] or ' ' }}</td>
                <td>{{ item['Tensiometro_24'] or ' ' }}</td>
                <td>{{ item['Observaciones'] or ' ' }}</td>
                <td>{{ item['Latitud'] or ' ' }}</td>
                <td>{{ item['Longitud'] or ' ' }}</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<div class="container">
    <h2>Gráfico de Tensiometros</h2>
    <div class="graph-container">
        <form method="GET" action="/ficha">
            <div class="form-group">
                <label for="lote_lineas">Seleccione un Lote:</label>
                <select name="lote_lineas" id="lote_lineas" class="form-control" onchange="this.form.submit()">
                    {% for lote in lotes %}
                    <option value="{{ lote }}" {% if lote == selected_lote %}selected{% endif %}>{{ lote }}</option>
                    {% endfor %}
                </select>
            </div>
        </form>
        {{ graph_html_lineas | safe }}
    </div>
    
    <div class="container mt-5">
        <h2>Conductividad Electrica y PH del Suelo</h2>
        
        {% if message %}
            <div class="alert alert-warning">{{ message }}</div>
        {% endif %}
        
        <form method="GET" action="/ficha" class="mb-4">
            <div class="form-row">
                <div class="form-group col-md-3">
                    <label for="fecha">Seleccionar Fecha:</label>
                    <select id="fecha" name="fecha" class="form-control" onchange="actualizarFiltros()">
                        <option value="">-- Seleccionar Fecha --</option>
                        {% for fecha in fechas_unicas %}
                            <option value="{{ fecha }}" {% if fecha == fecha_seleccionada %}selected{% endif %}>{{ fecha }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="form-group col-md-3">
                    <label for="lote">Seleccionar Lote:</label>
                    <select id="lote" name="lote" class="form-control" onchange="actualizarFiltros()">
                        <option value="">-- Seleccionar Lote --</option>
                        {% for lote in lotes_unicos %}
                            <option value="{{ lote }}" {% if lote == lote_seleccionado %}selected{% endif %}>{{ lote }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="form-group col-md-3">
                    <label for="turno">Seleccionar Turno:</label>
                    <select id="turno" name="turno" class="form-control" onchange="actualizarFiltros()">
                        <option value="">-- Seleccionar Turno --</option>
                        {% for turno in turnos_unicos %}
                            <option value="{{ turno }}" {% if turno == turno_seleccionado %}selected{% endif %}>{{ turno }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="form-group col-md-3">
                    <label for="valvula">Seleccionar Válvula:</label>
                    <select id="valvula" name="valvula" class="form-control" onchange="actualizarFiltros()">
                        <option value="">-- Seleccionar Válvula --</option>
                        {% for valvula in valvulas_unicas %}
                            <option value="{{ valvula }}" {% if valvula == valvula_seleccionada %}selected{% endif %}>{{ valvula }}</option>
                        {% endfor %}
                    </select>
                </div>
            </div>
            <button type="submit" class="btn btn-primary">Filtrar</button>
            <a href="/reset" class="btn btn-secondary">Reiniciar Filtros</a>
        </form>

        <div id="graph-container">
            {{ graph_html_puntos|safe }}
        </div>
    </div>

    <h2>Mapa Humedad del Suelo</h2>
    <div class="graph-container">
        <form method="GET" action="/ficha" id="filterForm">
            <label for="date">Seleccione una Fecha:</label>
            <select id="date" name="date" onchange="this.form.submit()">
                <option value="">Todas las Fechas</option>
                {% for fecha in fechas_disponibles %}
                    <option value="{{ fecha }}" 
                        {% if fecha == selected_date %} selected {% endif %}>
                        {{ fecha }}
                    </option>
                {% endfor %}
            </select>
        </form>
        
        <div class="folium-map">
            {{ folium_map_html | safe }}
        </div>
    </div>

    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css">
    <link rel="stylesheet" href="https://cdn.datatables.net/buttons/2.3.5/css/buttons.dataTables.min.css">
    <link rel="stylesheet" href="https://cdn.datatables.net/colvis/1.2.0/css/buttons.colVis.min.css">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/buttons/2.3.5/js/dataTables.buttons.min.js"></script>
    <script src="https://cdn.datatables.net/buttons/2.3.5/js/buttons.html5.min.js"></script>
    <script src="https://cdn.datatables.net/buttons/2.3.5/js/buttons.print.min.js"></script>
    <script src="https://cdn.datatables.net/buttons/2.3.5/js/buttons.colVis.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.4.0/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.13/jspdf.plugin.autotable.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>


    <script>
        $(document).ready(function() {
            var table = $('#miTabla').DataTable({
                "scrollX": true,
                "pageLength": 6,
                "language": {
                    "url": "//cdn.datatables.net/plug-ins/1.10.21/i18n/Spanish.json"
                },
                dom: 'Bfrtip',
                buttons: [
                    'colvis',
                    {
                        extend: 'copyHtml5',
                        text: 'Copiar',
                        title: 'Datos de Ficha Técnica',
                        exportOptions: {
                            columns: ':visible' // Exporta solo columnas visibles
                        }
                    },
                    {
                        extend: 'excelHtml5',
                        text: 'Exportar a Excel',
                        title: 'Datos de Ficha Técnica',
                        exportOptions: {
                            columns: ':visible' // Exporta solo columnas visibles
                        }
                    },
                    {
                        extend: 'pdfHtml5',
                        text: 'Exportar a PDF',
                        title: 'Datos de Ficha Técnica',
                        exportOptions: {
                            columns: ':visible' // Exporta solo columnas visibles
                        }
                    },
                    {
                        extend: 'print',
                        text: 'Imprimir',
                        title: 'Datos de Ficha Técnica',
                        exportOptions: {
                            columns: ':visible' // Exporta solo columnas visibles
                        }
                    }
                ]
            });

            // Asegúrate de que el contenido se ajuste al tamaño de la ventana
            $(window).on('resize', function() {
                table.columns.adjust().draw();
            });
        });
    </script>

<script>
    function actualizarFiltros() {
        var fecha = $('#fecha').val();
        var lote = $('#lote').val();
        var turno = $('#turno').val();

        $.get('/filtros', { fecha: fecha, lote: lote, turno: turno }, function(data) {
            // Actualizar Lotes
            var loteSelect = $('#lote');
            loteSelect.empty();
            loteSelect.append('<option value="">-- Seleccionar Lote --</option>');
            data.lotes.forEach(function(lote) {
                loteSelect.append('<option value="' + lote + '">' + lote + '</option>');
            });

            // Actualizar Turnos
            var turnoSelect = $('#turno');
            turnoSelect.empty();
            turnoSelect.append('<option value="">-- Seleccionar Turno --</option>');
            data.turnos.forEach(function(turno) {
                turnoSelect.append('<option value="' + turno + '">' + turno + '</option>');
            });

            // hasta aqui bueno
            var valvulaSelect = $('#valvula');
            valvulaSelect.empty();
            valvulaSelect.append('<option value="">-- Seleccionar Válvula --</option>');
            data.valvulas.forEach(function(valvula) {
                valvulaSelect.append('<option value="' + valvula + '">' + valvula + '</option>');
            });
        });
    }
</script>
</div>

{% endblock %}


